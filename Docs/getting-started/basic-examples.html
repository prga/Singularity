<!DOCTYPE HTML>
<html lang="en" >
    <!-- Start book Singularity -->
    <head>
        <!-- head:start -->
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Examples | Singularity</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    
        <link rel="stylesheet" href="../../styles/website.css">
    

        
    
    
    <link rel="next" href="../../Docs/development/developing-with-docker.html" />
    
    
    <link rel="prev" href="../../Docs/getting-started/install.html" />
    

        <!-- head:end -->
    </head>
    <body>
        <!-- body:start -->
        
    <div class="book"
        data-level="2.3"
        data-chapter-title="Examples"
        data-filepath="Docs/getting-started/basic-examples.md"
        data-basepath="../.."
        data-revision="Fri Dec 09 2016 13:43:22 GMT-0500 (EST)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" >
            
            <span><b>1.</b> About Singularity</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="Docs/about/how-it-works.html">
            
                
                    <a href="../../Docs/about/how-it-works.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        How It Works
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="Docs/about/requests-and-deploys.html">
            
                
                    <a href="../../Docs/about/requests-and-deploys.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Requests and Deploys
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="Docs/about/ui.html">
            
                
                    <a href="../../Docs/about/ui.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Singularity UI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="Docs/about/adopters.html">
            
                
                    <a href="../../Docs/about/adopters.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        Adopters
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" >
            
            <span><b>2.</b> Getting Started</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="Docs/getting-started/try-it-out.html">
            
                
                    <a href="../../Docs/getting-started/try-it-out.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Try It Out
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="Docs/getting-started/install.html">
            
                
                    <a href="../../Docs/getting-started/install.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Install
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.3" data-path="Docs/getting-started/basic-examples.html">
            
                
                    <a href="../../Docs/getting-started/basic-examples.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Examples
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" >
            
            <span><b>3.</b> Developing</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="Docs/development/developing-with-docker.html">
            
                
                    <a href="../../Docs/development/developing-with-docker.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Developing Using Docker
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="Docs/development/ui.html">
            
                
                    <a href="../../Docs/development/ui.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        UI
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="Docs/development/load-balancer-integration.html">
            
                
                    <a href="../../Docs/development/load-balancer-integration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Load Balancer Integration
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="Docs/development/basepom.html">
            
                
                    <a href="../../Docs/development/basepom.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        Basepom
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="Docs/releases/index.html">
            
                
                    <a href="../../Docs/releases/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Releases
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" >
            
            <span><b>5.</b> Feature Docs</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1" data-path="Docs/features/custom-ports.html">
            
                
                    <a href="../../Docs/features/custom-ports.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.</b>
                        
                        Choosing Custom Ports
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="Docs/features/expiring-actions.html">
            
                
                    <a href="../../Docs/features/expiring-actions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.</b>
                        
                        Expiring Actions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="Docs/features/shell-commands.html">
            
                
                    <a href="../../Docs/features/shell-commands.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.3.</b>
                        
                        Shell Commands
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="Docs/features/task-search.html">
            
                
                    <a href="../../Docs/features/task-search.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.4.</b>
                        
                        Task Search
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="Docs/features/incremental-deploys.html">
            
                
                    <a href="../../Docs/features/incremental-deploys.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.5.</b>
                        
                        Incremental Deploys
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="Docs/features/disaster-detection.html">
            
                
                    <a href="../../Docs/features/disaster-detection.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.6.</b>
                        
                        Disaster Detection &amp; Disabled Actions
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6" >
            
            <span><b>6.</b> Reference</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1" data-path="Docs/reference/configuration.html">
            
                
                    <a href="../../Docs/reference/configuration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.1.</b>
                        
                        Configuration
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="Docs/reference/container-options.html">
            
                
                    <a href="../../Docs/reference/container-options.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.2.</b>
                        
                        Container Options
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="Docs/reference/database.html">
            
                
                    <a href="../../Docs/reference/database.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.3.</b>
                        
                        Database
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="Docs/reference/webhooks.html">
            
                
                    <a href="../../Docs/reference/webhooks.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.4.</b>
                        
                        Webhooks
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="Docs/reference/slave-extras.html">
            
                
                    <a href="../../Docs/reference/slave-extras.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.5.</b>
                        
                        Slave Extras
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.6" data-path="Docs/reference/deploy-defaults.html">
            
                
                    <a href="../../Docs/reference/deploy-defaults.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.6.</b>
                        
                        Deploy Defaults
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7" data-path="Docs/reference/apidocs/api-index.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.</b>
                        
                        API
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.7.1" data-path="Docs/reference/apidocs/api-sandbox.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-sandbox.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.1.</b>
                        
                        /api/sandbox
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.2" data-path="Docs/reference/apidocs/api-slaves.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-slaves.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.2.</b>
                        
                        /api/slaves
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.3" data-path="Docs/reference/apidocs/api-history.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-history.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.3.</b>
                        
                        /api/history
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.4" data-path="Docs/reference/apidocs/api-state.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-state.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.4.</b>
                        
                        /api/state
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.5" data-path="Docs/reference/apidocs/api-logs.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-logs.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.5.</b>
                        
                        /api/logs
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.6" data-path="Docs/reference/apidocs/api-tasks.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-tasks.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.6.</b>
                        
                        /api/tasks
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.7" data-path="Docs/reference/apidocs/api-test.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-test.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.7.</b>
                        
                        /api/test
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.8" data-path="Docs/reference/apidocs/api-webhooks.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-webhooks.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.8.</b>
                        
                        /api/webhooks
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.9" data-path="Docs/reference/apidocs/api-racks.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-racks.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.9.</b>
                        
                        /api/racks
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.10" data-path="Docs/reference/apidocs/api-requests.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-requests.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.10.</b>
                        
                        /api/requests
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.11" data-path="Docs/reference/apidocs/api-deploys.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-deploys.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.11.</b>
                        
                        /api/deploys
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.12" data-path="Docs/reference/apidocs/api-disasters.html">
            
                
                    <a href="../../Docs/reference/apidocs/api-disasters.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.12.</b>
                        
                        /api/disasters
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6.7.13" data-path="Docs/reference/apidocs/models.html">
            
                
                    <a href="../../Docs/reference/apidocs/models.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.7.13.</b>
                        
                        Models
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Singularity</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="singularity-deploy-examples">Singularity Deploy Examples</h1>
<ul>
<li><a href="#creating-a-request">Creating A Request</a></li>
<li><a href="#basic-service-using-the-mesos-executor">Basic Service Using the Mesos Executor</a></li>
<li><a href="#basic-service-using-allocated-ports">Basic Service Using Allocated Ports</a></li>
<li><a href="#basic-load-balanced-service-with-allocated-ports">Basic Load Balanced Service with Allocated Ports</a></li>
<li><a href="#scaling-up">Scaling Up Services</a></li>
<li><a href="#docker-service-with-host-networking">Docker Service with Host Networking</a></li>
<li><a href="#docker-service-with-bridge-networking">Docker Service with Bridge Networking</a></li>
<li><a href="#load-balanced-docker-service-using-the-singularityexecutor">Load Balanced Docker Service Using The SingularityExecutor</a></li>
</ul>
<p>These examples assume you have <a href="install.html">installed Singularity</a>.</p>
<p>The services deployed will be a <a href="https://github.com/HubSpot/singularity-test-service" target="_blank">build</a> of a sample Dropwizard service. It has two enpoints <code>/hello</code> and <code>/environment</code>.</p>
<p><em>For this walkthrough we will assume you are using the <a href="try-it-out.html">docker-compose example cluster</a> and that Singularity is running at <code>http://localhost:7099/singularity</code>. For your own case you can replace <code>localhost</code> with whatever host Singularity is running on in your setup. (e.g. if using <code>boot2docker</code> you would use the vm&apos;s ip of 192.168.59.103)</em></p>
<h2 id="creating-a-request">Creating A Request</h2>
<p>All deployments belong to <a href="../about/requests-and-deploys.html">requests</a>. Before you can deploy you need to create a request. A request represents your service or scheduled job.</p>
<p>Create a new request on the new request page (<a href="http://localhost:7099/singularity/requests/new" target="_blank"><code>/singularity/requests/new</code></a>) in the ui, and set the following:</p>
<ul>
<li>ID: singularity-test-service</li>
<li>Owners: Your email address</li>
<li>Type: Service</li>
</ul>
<p>You can also create the request using a JSON HTTP POST:</p>
<pre><code class="lang-json">{
    &quot;id&quot;: &quot;singularity-test-service&quot;,
    &quot;owners&quot;: [
        &quot;you@example.com&quot;
    ],
    &quot;requestType&quot;: &quot;SERVICE&quot;,
    &quot;rackSensitive&quot;: false,
    &quot;loadBalanced&quot;: false
}
</code></pre>
<p>You can POST this JSON (saved in request.json) using curl:</p>
<pre><code class="lang-sh">curl -i -X POST -H &quot;Content-Type: application/json&quot; -d@request.json \
http://locahost:7099/singularity/api/requests
</code></pre>
<h2 id="basic-service-using-the-mesos-executor">Basic Service Using the Mesos Executor</h2>
<p>In order to deploy using the default Mesos executor you will need to push the deployment artifacts to an accessible location. In this example they are available in a GitHub <a href="https://github.com/HubSpot/singularity-test-service/releases/tag/1.0" target="_blank">release</a>.</p>
<p>To deploy using the web UI:</p>
<ul>
<li>Deploy ID: 1</li>
<li>Command to execute: <code>java -jar singularitytest-1.0-SNAPSHOT.jar server example.yml</code></li>
<li>Artifacts:<ul>
<li><code>https://github.com/HubSpot/singularity-test-service/releases/download/1.0/singularitytest-1.0-SNAPSHOT.jar</code></li>
<li><code>https://github.com/HubSpot/singularity-test-service/releases/download/1.0/example.yml</code></li>
</ul>
</li>
<li>CPUs: 0.1 (in the default docker setup there is only one CPU resource in the slave, to test multiple deployments and scaling we&apos;ll use less CPU resources.)</li>
</ul>
<p>The equivalent JSON which can be used instead of the web UI:</p>
<pre><code class="lang-json">{
    &quot;deploy&quot;: {
        &quot;requestId&quot;: &quot;singularity-test-service&quot;,
        &quot;id&quot;: &quot;1&quot;,
        &quot;command&quot;: &quot;java -jar singularitytest-1.0-SNAPSHOT.jar server example.yml&quot;,
        &quot;resources&quot;: {
            &quot;cpus&quot;: 0.1,
            &quot;memoryMb&quot;: 128,
            &quot;numPorts&quot;: 2
        },
        &quot;uris&quot;: [
            &quot;https://github.com/HubSpot/singularity-test-service/releases/download/1.0/singularitytest-1.0-SNAPSHOT.jar&quot;, 
            &quot;https://github.com/HubSpot/singularity-test-service/releases/download/1.0/example.yml&quot;
        ]
    }
}
</code></pre>
<p>You can POST this JSON (saved in deploy.json) using curl:</p>
<pre><code class="lang-sh">curl -i -X POST -H &quot;Content-Type: application/json&quot; -d@deploy.json \
http://localhost:7099/singularity/api/deploys
</code></pre>
<p>When the task launches nothing may be visible in the Singularity UI at first, this is due to the Mesos executor fetching the artifacts first.</p>
<p>Once the task is running you can go to <a href="http://localhost:7099/singularity/requests/singularity-test-service" target="_blank">http://localhost:7099/singularity/requests/singularity-test-service</a> to see the currently running tasks and status of the request.</p>
<h3 id="limitations">Limitations</h3>
<ul>
<li>Since this container is bound to the ports 8080 and 8081 on the host machine you can&apos;t scale it up to more than one per machine. Depending on your setup, you may already see port in use errors when starting the app, as those ports are commonly used by other processes.</li>
<li>Since Singularity isn&apos;t allocating the ports and we have not specified a port to use for checks you can&apos;t use the health check. (<em>See <a href="../features/custom-ports.html">choosing ports</a> for info on selecting specific ports</em>)</li>
</ul>
<h2 id="basic-service-using-dynamically-allocated-ports">Basic Service Using Dynamically Allocated Ports</h2>
<p>Singularity can allocate ports to the service, this allows multiple services to run on the same machine, even when they would ordinarily have port clashes.</p>
<p>When allocating ports Singularity will set PORT0...N environment variables you can use to map your service&apos;s ports.</p>
<p>The Dropwizard example exposes a healthcheck on <code>http://(host):8081/healthcheck</code>. This can be used by Singularity to determine the healthiness of the service on deploys or when a new task is launched.</p>
<p>The health check by default uses the first port on the container, so we&apos;ll need to map it before the application port.</p>
<p>In this example we&apos;ll be using <code>java -Ddw.server.applicationConnectors[0].port=$PORT1 -Ddw.server.adminConnectors[0].port=$PORT0  ...</code> to map the ports, the Singularity health check uses the first available port so we&apos;ll assign admin to port 0 to ensure /healthcheck works.</p>
<p>Make another deploy request:</p>
<ul>
<li>Deploy ID: 2</li>
<li>Command to execute: <code>java -Ddw.server.applicationConnectors[0].port=$PORT1 -Ddw.server.adminConnectors[0].port=$PORT0 -jar singularitytest-1.0-SNAPSHOT.jar server example.yml</code></li>
<li>Artifacts:<ul>
<li><code>https://github.com/HubSpot/singularity-test-service/releases/download/1.0/singularitytest-1.0-SNAPSHOT.jar</code></li>
<li><code>https://github.com/HubSpot/singularity-test-service/releases/download/1.0/example.yml</code></li>
</ul>
</li>
<li>CPUs: 0.1 </li>
<li>Num. ports: 2</li>
<li>Healthcheck URI: /healthcheck</li>
</ul>
<p>Or post the following JSON:</p>
<pre><code class="lang-json">{
    &quot;deploy&quot;: {
        &quot;requestId&quot;: &quot;singularity-test-service&quot;,
        &quot;id&quot;: &quot;2&quot;,
        &quot;command&quot;: &quot;java -Ddw.server.applicationConnectors[0].port=$PORT1 -Ddw.server.adminConnectors[0].port=$PORT0 -jar singularitytest-1.0-SNAPSHOT.jar server example.yml&quot;,
        &quot;resources&quot;: {
            &quot;cpus&quot;: 0.1,
            &quot;memoryMb&quot;: 128,
            &quot;numPorts&quot;: 2
        },
        &quot;uris&quot;: [
            &quot;https://github.com/HubSpot/singularity-test-service/releases/download/1.0/singularitytest-1.0-SNAPSHOT.jar&quot;, 
            &quot;https://github.com/HubSpot/singularity-test-service/releases/download/1.0/example.yml&quot;
        ],
        &quot;healthcheckUri&quot;: &quot;/healthcheck&quot;
    }
}
</code></pre>
<p>You can navigate to the running task in the UI and get the two ports. You can then access the service on those ports (for example my service got allocated 31428,31429, so I could then use <code>curl http://localhost:31429/</code> to fetch the hello world JSON).</p>
<h2 id="basic-load-balanced-service-with-allocated-ports">Basic Load Balanced Service with Allocated Ports</h2>
<p>If Singularity is <a href="../development/load-balancer-integration.html">configured with a load balancer api</a> like <a href="https://github.com/HubSpot/Baragon" target="_blank">Baragon</a>, you can also have Singularity keep your load balancer up to date. When a task is started and healthy, Singularity will notify the load balacner api of the new service and the port that it is running on.</p>
<p>Because our previous request is already running, you cannot update our non-load-balanced service to be load balanced. Instead, create a new request for a load balanced version of our service. This can be done by POSTing json to the request endpoint similar to the following (note the <code>&quot;loadBalanced&quot;: true</code>).</p>
<pre><code class="lang-json">{
    &quot;id&quot;: &quot;singularity-test-load-balanced-service&quot;,
    &quot;owners&quot;: [
        &quot;you@example.com&quot;
    ],
    &quot;requestType&quot;: &quot;SERVICE&quot;,
    &quot;rackSensitive&quot;: false,
    &quot;loadBalanced&quot;: true
}
</code></pre>
<p>You can POST this JSON (saved in request.json) using curl:</p>
<pre><code class="lang-sh">curl -i -X POST -H &quot;Content-Type: application/json&quot; -d@request.json \
http://locahost:7099/singularity/api/requests
</code></pre>
<p>We will need to add some information for the load balancer api to our JSON:</p>
<pre><code>&quot;serviceBasePath&quot;:&quot;/&quot;,
&quot;loadBalancerGroups&quot;:[&quot;test&quot;]
</code></pre><p>This allows Singularity to tell the load balancer api what groups/clusters the service should be available on, and what path on that cluster belongs to this service.</p>
<p>Make another deploy request by posting the following JSON:</p>
<pre><code class="lang-json">{
    &quot;deploy&quot;: {
        &quot;requestId&quot;: &quot;singularity-test-load-balanced-service&quot;,
        &quot;id&quot;: &quot;3&quot;,
        &quot;command&quot;: &quot;java -Ddw.server.applicationConnectors[0].port=$PORT1 -Ddw.server.adminConnectors[0].port=$PORT0 -jar singularitytest-1.0-SNAPSHOT.jar server example.yml&quot;,
        &quot;resources&quot;: {
            &quot;cpus&quot;: 0.1,
            &quot;memoryMb&quot;: 128,
            &quot;numPorts&quot;: 2
        },
        &quot;uris&quot;: [
            &quot;https://github.com/HubSpot/singularity-test-service/releases/download/1.0/singularitytest-1.0-SNAPSHOT.jar&quot;, 
            &quot;https://github.com/HubSpot/singularity-test-service/releases/download/1.0/example.yml&quot;
        ],
        &quot;skipHealthchecksOnDeploy&quot;: false,
        &quot;healthcheckUri&quot;: &quot;/healthcheck&quot;,
        &quot;serviceBasePath&quot;:&quot;/&quot;,
        &quot;loadBalancerGroups&quot;:[&quot;test&quot;]
    }
}
</code></pre>
<p>After the task becomes healthy you will also be able to see that the service was successfully <a href="http://localhost:8080/baragon/v2/ui/services" target="_blank">registered with the load balancer api</a>. </p>
<h2 id="scaling-up">Scaling Up</h2>
<p>Scaling up is easy, navigate to your <a href="http://localhost:7099/singularity/request/singularity-test-service" target="_blank">request</a> and click the &quot;Scale&quot; button. Type in a new value (e.g. 3) and wait for the new tasks to run. Since the ports are managed by Singularity you don&apos;t have to worry about them clashing.</p>
<p>Side note: You&apos;ll notice that each running task returns different ids in the hello world response. This is due to each being an independent process, with separate counters.</p>
<h2 id="docker-service-with-host-networking">Docker Service with Host Networking</h2>
<p>An alternative approach to running in the Mesos executor (or the Singularity executor) is to use <a href="https://docker.com" target="_blank">Docker</a>.</p>
<p>There is a <a href="https://hub.docker.com/r/hubspot/singularity-test-service/" target="_blank">Docker image</a> built of the example service which can be used for deployments.</p>
<p>Since we are using host networking the Docker container will bind to the host ports 8080 and 8081 again, so we will need to first scale down the current instances.</p>
<p>To scale down go to your <a href="http://localhost:7099/singularity/request/singularity-test-service" target="_blank">request</a> and click the &quot;Scale&quot; button again. Enter in 1 to reduce the number of running tasks. You should see two of the tasks move into &quot;Task Cleaning&quot; states.</p>
<p>To deploy this image create another deployment, but use Docker instead of default:</p>
<ul>
<li>ID: 3</li>
<li>Executor Type: Docker</li>
<li>Docker Image: hubspot/singularity-test-service:1.0</li>
<li>CPUs: 0.1</li>
</ul>
<p>The equivalent JSON:</p>
<pre><code class="lang-json">{
    &quot;deploy&quot;: {
        &quot;requestId&quot;: &quot;singularity-test-service&quot;,
        &quot;id&quot;: &quot;3&quot;,
        &quot;containerInfo&quot;: {
            &quot;type&quot;: &quot;DOCKER&quot;,
            &quot;docker&quot;: {
                &quot;network&quot;: &quot;HOST&quot;,
                &quot;image&quot;: &quot;hubspot/singularity-test-service:1.0&quot;
            }
        },
        &quot;resources&quot;: {
            &quot;cpus&quot;: 0.1,
            &quot;memoryMb&quot;: 128,
            &quot;numPorts&quot;: 0
        }
    }
}
</code></pre>
<p>This will pull down the Docker image from the Docker registry and start the container. The ports will be bound to the Mesos slave host, so the service will be available again at <a href="http://localhost:8080/" target="_blank">http://localhost:8080/</a>. The command to run is already set in the docker image, so in this case it is not set in the deploy. Any command set in the deploy json will override the command for the docker container (i.e CMD in Dockerfile)</p>
<h2 id="docker-service-with-bridge-networking-and-dynamically-allocated-ports">Docker Service with Bridge Networking and Dynamically Allocated Ports</h2>
<p>Instead of binding to the host network Docker can set up a bridge network and bind the container&apos;s ports to the external ports. The container doesn&apos;t have to know what the external ports are (or if they are bound at all), so you don&apos;t have to pass this configuration into the container.</p>
<p>You could specify port mappings in the Singularity UI or POST JSON like the following:</p>
<pre><code class="lang-json">{
    &quot;deploy&quot;: {
        &quot;requestId&quot;: &quot;singularity-test-service&quot;,
        &quot;id&quot;: &quot;4&quot;,
        &quot;containerInfo&quot;: {
            &quot;type&quot;: &quot;DOCKER&quot;,
            &quot;docker&quot;: {
                &quot;network&quot;: &quot;BRIDGE&quot;,
                &quot;image&quot;: &quot;hubspot/singularity-test-service:1.0&quot;,
                &quot;portMappings&quot;: [
                    {
                        &quot;containerPortType&quot;: &quot;LITERAL&quot;,
                        &quot;containerPort&quot;: 8081,
                        &quot;hostPortType&quot;: &quot;FROM_OFFER&quot;,
                        &quot;hostPort&quot;: 0,
                        &quot;protocol&quot;: &quot;tcp&quot;
                    },
                    {
                        &quot;containerPortType&quot;: &quot;LITERAL&quot;,
                        &quot;containerPort&quot;: 8080,
                        &quot;hostPortType&quot;: &quot;FROM_OFFER&quot;,
                        &quot;hostPort&quot;: 1,
                        &quot;protocol&quot;: &quot;tcp&quot;
                    }
                ]
            }
        },
        &quot;resources&quot;: {
            &quot;cpus&quot;: 0.1,
            &quot;memoryMb&quot;: 128,
            &quot;numPorts&quot;: 2
        },
        &quot;healthcheckUri&quot;: &quot;/healthcheck&quot;
    }
}
</code></pre>
<p>Post this using curl:</p>
<pre><code class="lang-sh">curl -i -X POST -H &quot;Content-Type: application/json&quot; -d@deploy.json  http://localhost:7099/singularity/api/deploys
</code></pre>
<p>The <code>FROM_OFFER</code> specification and <code>hostPort</code> of <code>0</code> lets Singularity know to use the dynamically allocated port with index <code>0</code> (i.e. the first port) as the <code>hostPort</code>.</p>
<p>You can go back to the <a href="http://localhost:7099/singularity/request/singularity-test-service" target="_blank">request</a> and watch the task starting.</p>
<p>You can also scale it up in a similar manner, this time you should notice the new tasks starting much faster. This is because the Docker layers are already on the machine, so the Docker pull should be nearly instant.</p>
<h2 id="load-balanced-service-using-the-singularityexecutor">Load Balanced Service Using The SingularityExecutor</h2>
<p>As we saw above we can add the <code>loadBalancerGroups</code> and <code>serviceBasePath</code> fields to our deploy and have our service be load balanced.</p>
<p>Now, we also want to add in the SingularityExecutor, Singularity&apos;s custom executor. We can use the SingularityExecutor by adding a <code>customExecutorCmd</code> (where to find the executor code) and <code>executorData</code> (data to pass to our custom executor) in the deploy JSON:</p>
<pre><code class="lang-json">{
    &quot;deploy&quot;: {
        &quot;requestId&quot;: &quot;singularity-test-load-balanced-service&quot;,
        &quot;id&quot;: &quot;4&quot;,
        &quot;resources&quot;: {
            &quot;cpus&quot;: 0.1,
            &quot;memoryMb&quot;: 128,
            &quot;numPorts&quot;: 2
        },
        &quot;healthcheckUri&quot;: &quot;/healthcheck&quot;,
        &quot;serviceBasePath&quot;:&quot;/&quot;,
        &quot;loadBalancerGroups&quot;:[&quot;test&quot;],
        &quot;customExecutorCmd&quot;: &quot;/usr/local/bin/singularity-executor&quot;,
        &quot;executorData&quot;: {
            &quot;cmd&quot;:&quot;java -Ddw.server.applicationConnectors[0].port=$PORT1 -Ddw.server.adminConnectors[0].port=$PORT0 -jar singularitytest-1.0-SNAPSHOT.jar server example.yml&quot;,
            &quot;embeddedArtifacts&quot;:[],
            &quot;externalArtifacts&quot;: [
                {
                    &quot;name&quot;: &quot;singularitytest-1.0-SNAPSHOT.jar&quot;,
                    &quot;filename&quot;: &quot;singularitytest-1.0-SNAPSHOT.jar&quot;,
                    &quot;url&quot;: &quot;https://github.com/HubSpot/singularity-test-service/releases/download/1.0/singularitytest-1.0-SNAPSHOT.jar&quot;
                },
                {
                    &quot;name&quot;: &quot;example.yml&quot;,
                    &quot;filename&quot;: &quot;example.yml&quot;,
                    &quot;url&quot;: &quot;https://github.com/HubSpot/singularity-test-service/releases/download/1.0/example.yml&quot;
                }
            ],
            &quot;s3Artifacts&quot;: [],
            &quot;successfulExitCodes&quot;: [0],
            &quot;user&quot;: &quot;root&quot;,
            &quot;extraCmdLineArgs&quot;: [],
            &quot;loggingExtraFields&quot;: {},
            &quot;maxTaskThreads&quot;: 2048
        }
    }
}
</code></pre>
<p><code>POST</code>ing this to Singularity we now have a docker container with mapped ports connected to a load balancer and running via the SingularityExecutor.</p>
<p>Note that the SingularityExecutor <a href="../reference/container-options.html">also has docker support</a> (separate form the mesos docker containerizer). By specifying a <code>containerInfo</code> section, the SingularityExecutor will manage the lifecycle of your container.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../Docs/getting-started/install.html" class="navigation navigation-prev " aria-label="Previous page: Install"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../Docs/development/developing-with-docker.html" class="navigation navigation-next " aria-label="Next page: Developing Using Docker"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-github/plugin.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-copy-code-button/toggle.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"github":{"url":"https://github.com/HubSpot/Singularity"},"copy-code-button":{},"search":{"maxIndexSize":1000000},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        <!-- body:end -->
    </body>
    <!-- End of book Singularity -->
</html>
